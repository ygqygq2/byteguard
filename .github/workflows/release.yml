name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew build -Pversion=${{ steps.get_version.outputs.VERSION }} --no-daemon

    - name: Build Fat JAR
      run: ./gradlew :byteguard-cli:shadowJar -Pversion=${{ steps.get_version.outputs.VERSION }} --no-daemon

    - name: Run all tests
      run: ./gradlew test integrationTest --no-daemon

    - name: Extract Changelog
      run: |
        # 使用 awk 命令提取最新的版本记录
        cat CHANGELOG.md | awk '/^## \[/ {if (flag) exit; flag=1} flag {print}' > body.md
        cat body.md

    - name: Publish release
      uses: ncipollo/release-action@v1.20.0
      with:
        name: ByteGuard ${{ steps.get_version.outputs.VERSION }}
        bodyFile: 'body.md'
        draft: false
        prerelease: false
        artifacts: |
          byteguard-cli/build/libs/byteguard-cli-${{ steps.get_version.outputs.VERSION }}.jar
          byteguard-cli/build/libs/byteguard-cli-${{ steps.get_version.outputs.VERSION }}-all.jar
          byteguard-core/build/libs/byteguard-core-${{ steps.get_version.outputs.VERSION }}.jar
          byteguard-maven-plugin/build/libs/byteguard-maven-plugin-${{ steps.get_version.outputs.VERSION }}.jar
        token: ${{ secrets.GITHUB_TOKEN }}

  publish-maven-central:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v6.3.0
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}

    - name: Publish to Maven Central
      env:
        OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
        SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
      run: |
        ./gradlew publish \
          -Pversion=${{ steps.get_version.outputs.VERSION }} \
          -PossrhUsername=$OSSRH_USERNAME \
          -PossrhPassword=$OSSRH_PASSWORD \
          -Psigning.keyId=$SIGNING_KEY_ID \
          -Psigning.password=$SIGNING_PASSWORD

    - name: Close and release staging repository
      run: ./gradlew closeAndReleaseRepository
